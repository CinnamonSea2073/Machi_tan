<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…ˆç”Ÿç”»é¢ - Machi_tan</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    .card{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:16px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .card-title{font-size:18px;font-weight:600;color:#333}
    .empty-state{color:#999;font-size:14px;padding:12px;text-align:center}
    .course-item{padding:10px;border:1px solid #e0e0e0;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .course-id{font-weight:500;color:#1976d2}
    .status-item{padding:8px 12px;background:#f0f0f0;border-radius:6px;margin:4px;display:inline-block}
    .comment-item{padding:12px;border-left:3px solid #1976d2;background:#f9f9f9;border-radius:4px;margin-bottom:8px}
    .comment-meta{font-size:12px;color:#666;margin-bottom:4px}
    .info-box{padding:12px;background:#e3f2fd;border-radius:6px;color:#1565c0;margin-top:8px}
    .btn-small{padding:6px 12px;font-size:14px}
    .course-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:flex;align-items:center;justify-content:center}
    .course-modal-content{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:800px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .course-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .course-item-actions{display:flex;gap:8px}
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="header">
      <div class="h1">å…ˆç”Ÿç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ğŸ“š</div>
      <button class="btn btn-small" id="refresh">ğŸ”„ å…¨æ›´æ–°</button>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ã‚³ãƒ¼ã‚¹ç™»éŒ²ï¼ˆGPXï¼‰</div>
      </div>
      <div class="row">
        <input type="file" id="gpxfile" class="col" accept=".gpx" />
        <button class="btn" id="uploadBtn">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ã‚³ãƒ¼ã‚¹ä¸€è¦§</div>
        <button class="btn btn-small" id="refreshCourses">æ›´æ–°</button>
      </div>
      <div id="coursesList" class="list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">å½“æ—¥ã®ã‚³ãƒ¼ã‚¹è¨­å®š</div>
      </div>
      <div class="row">
        <select id="todayCourse" class="input col"></select>
        <button class="btn" id="setToday">âœ“ è¨­å®š</button>
      </div>
      <div id="todayInfo" class="info-box" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</div>
        <button class="btn btn-small" id="refreshStatus">æ›´æ–°</button>
      </div>
      <div class="row" style="margin-bottom:12px">
        <select id="statusSelect" class="input col">
          <option value="">-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ --</option>
          <option value="ãƒ‡ãƒãƒƒã‚°">ãƒ‡ãƒãƒƒã‚°</option>
          <option value="æº–å‚™ä¸­">æº–å‚™ä¸­</option>
          <option value="å®Ÿè¡Œä¸­">å®Ÿè¡Œä¸­</option>
          <option value="ä¼‘æ†©ä¸­">ä¼‘æ†©ä¸­</option>
          <option value="å®Œäº†">å®Œäº†</option>
        </select>
        <button class="btn" id="setStatus">âœ“ è¨­å®š</button>
      </div>
  <div id="currentStatus" class="info-box">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <strong>èª­ã¿è¾¼ã¿ä¸­...</strong></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ç”Ÿå¾’ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæœ€æ–°ï¼‰</div>
        <button class="btn btn-small" id="refreshComments">æ›´æ–°</button>
      </div>
      <div id="commentsList" class="list"></div>
    </div>
  </div>

  <!-- Course Preview Modal -->
  <div id="courseModal" class="course-modal" style="display:none">
    <div class="course-modal-content">
      <div class="course-modal-header">
        <h3 id="modalCourseTitle">ã‚³ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <button id="closeModal" class="btn btn-small">âœ• é–‰ã˜ã‚‹</button>
      </div>
      <div id="courseMap" style="width:100%;height:400px;border-radius:8px;"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/static/common.js"></script>
  <script>
    // Helper to attempt to repair mojibake caused by UTF-8 bytes being
    // interpreted as single-byte (latin1) characters. It reconstructs
    // the original byte sequence from the JS string and decodes as utf-8.
    function tryFixMojibake(s){
      if(!s || typeof s !== 'string') return s
      // quick check: if string contains replacement char or many '?', attempt fix
      if(!(/[\uFFFD\?]/.test(s))) return s
      try{
        const bytes = new Uint8Array(s.length)
        for(let i=0;i<s.length;i++) bytes[i] = s.charCodeAt(i) & 0xFF
        const dec = new TextDecoder('utf-8', {fatal:false}).decode(bytes)
        // if decoded string contains non-ascii characters, return it
        if(/[\u0080-\uFFFF]/.test(dec)) return dec
      }catch(e){ console.warn('mojibake fix failed', e) }
      return s
    }

    const app = Vue.createApp({})
    app.mount('#app')

    let courseMap = null
    // teacher comment markers
    let teacherCommentMarkers = {}

    function addTeacherCommentMarker(c){
      try{
        const lat = (c.lat !== undefined && c.lat !== null) ? Number(c.lat) : null
        const lon = (c.lon !== undefined && c.lon !== null) ? Number(c.lon) : null
        if(lat === null || lon === null) return
        if(Number.isNaN(lat) || Number.isNaN(lon)) return
        if(teacherCommentMarkers[c.comment_id]) return
  const iconHtml = `
    <div style="position:relative;width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
      <div style="position:absolute;width:40px;height:40px;border-radius:50%;background:rgba(255,215,0,0.18);box-shadow:0 2px 8px rgba(0,0,0,0.15);"></div>
      <div style="color:#FFD700;font-size:22px;z-index:2;text-shadow:0 2px 6px rgba(0,0,0,0.35);">â˜…</div>
    </div>`
  const icon = L.divIcon({className:'', html:iconHtml, iconSize:[40,40], iconAnchor:[20,20]})
        const m = L.marker([lat, lon], { icon, zIndexOffset: 1000 }).addTo(courseMap)
        let timeStr = ''
        try{ timeStr = c.created_at ? new Date(c.created_at).toLocaleString('ja-JP') : '' }catch(e){}
        const popupHtml = `<div style="min-width:160px"><strong>${c.student_name || c.user_id}</strong>${timeStr?`<div style=\"font-size:12px;color:#666\">${timeStr}</div>`:''}<div style=\"margin-top:6px\">${c.text}</div></div>`
        m.bindPopup(popupHtml)
        teacherCommentMarkers[c.comment_id] = m
      }catch(e){console.warn('addTeacherCommentMarker failed', e)}
    }

    // ã‚³ãƒ¼ã‚¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    async function previewCourse(courseId, courseName) {
      // courseName ãŒä¸ãˆã‚‰ã‚Œãªã‘ã‚Œã° courseId ã‚’ä»£ç”¨
      courseName = courseName || courseId
      const modal = document.getElementById('courseModal')
      const title = document.getElementById('modalCourseTitle')
      if (title) title.textContent = `ã‚³ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${courseName}`
      if (modal) modal.style.display = 'block'

      // åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      const mapContainer = document.getElementById('courseMap')
      if (mapContainer) mapContainer.innerHTML = ''

      try {
        // GPXãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—
        const response = await fetch(`/api/courses/${courseId}`)
        if (!response.ok) throw new Error('ã‚³ãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
        
        const courseData = await response.json()
        // ã‚µãƒ¼ãƒãƒ¼ã¯ 'gpx' ã‚­ãƒ¼ã§è¿”ã™ï¼ˆä»¥å‰ã®å®Ÿè£…ã§ã¯ 'content' ã‚’æœŸå¾…ã—ã¦ã„ãŸï¼‰
        const gpxContent = courseData.gpx || courseData.content || courseData.gpx_content

        // æ—¢å­˜ã®åœ°å›³ãŒã‚ã‚Œã°ç ´æ£„ã—ã¦ãŠã
        if (courseMap) {
          courseMap.remove()
          courseMap = null
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒç¢ºå®šã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆoffsetWidth null ã‚’å›é¿ï¼‰
        await new Promise(resolve => requestAnimationFrame(resolve))

        // åœ°å›³ã‚’åˆæœŸåŒ–
        courseMap = L.map('courseMap')
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(courseMap)

        // GPXãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
        const parser = new DOMParser()
        const gpxDoc = parser.parseFromString(gpxContent, 'text/xml')
        const trackPoints = gpxDoc.querySelectorAll('trkpt')
        
        if (trackPoints.length === 0) {
          throw new Error('GPXãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
        }

        // åº§æ¨™ã‚’LatLngã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã«å¤‰æ›
        const coordinates = []
        trackPoints.forEach(point => {
          const lat = parseFloat(point.getAttribute('lat'))
          const lng = parseFloat(point.getAttribute('lon'))
          coordinates.push([lat, lng])
        })

        // ãƒ«ãƒ¼ãƒˆã‚’ãƒ©ã‚¤ãƒ³ã¨ã—ã¦åœ°å›³ã«è¡¨ç¤º
        const routeLine = L.polyline(coordinates, {
          color: 'red',
          weight: 3,
          opacity: 0.8
        }).addTo(courseMap)

        // åœ°å›³ã®è¡¨ç¤ºç¯„å›²ã‚’ãƒ«ãƒ¼ãƒˆå…¨ä½“ã«åˆã‚ã›ã‚‹
        courseMap.fitBounds(routeLine.getBounds(), { padding: [20, 20] })

        // ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã‚´ãƒ¼ãƒ«ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        if (coordinates.length > 0) {
          L.marker(coordinates[0])
            .addTo(courseMap)
            .bindPopup('ã‚¹ã‚¿ãƒ¼ãƒˆ')
          
          if (coordinates.length > 1) {
            L.marker(coordinates[coordinates.length - 1])
              .addTo(courseMap)
              .bindPopup('ã‚´ãƒ¼ãƒ«')
          }
        }

      } catch (error) {
        console.error('ã‚³ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error)
        if (mapContainer) mapContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeCourseModal() {
      const modal = document.getElementById('courseModal')
      if (modal) modal.style.display = 'none'
      
      // åœ°å›³ã‚’ç ´æ£„
      if (courseMap) {
        courseMap.remove()
        courseMap = null
      }
    }

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    const closeBtn = document.getElementById('closeModal')
    if (closeBtn) closeBtn.addEventListener('click', closeCourseModal)

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('courseModal')
      if (event.target === modal) {
        closeCourseModal()
      }
    }

    async function loadCourses(){
      try{
        const data = await api('/api/courses')
        const sel = document.getElementById('todayCourse')
        const list = document.getElementById('coursesList')
        sel.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>'
        list.innerHTML = ''
        if(data.length === 0){
          list.innerHTML = '<div class="empty-state">ã‚³ãƒ¼ã‚¹ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'
        }else{
          data.forEach(c=>{
            const opt = document.createElement('option');opt.value=c.course_id;opt.textContent=c.course_id;sel.appendChild(opt)
            const div = document.createElement('div');div.className='course-item'
            div.innerHTML = `
              <div>
                <span class="course-id">${c.course_id}</span>
                <br><span style="font-size:12px;color:#999">${c.created_at}</span>
              </div>
              <div class="course-item-actions">
                <button class="btn btn-small" onclick="previewCourse('${c.course_id}')">ğŸ—ºï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
              </div>
            `
            list.appendChild(div)
          })
        }
      }catch(e){console.error(e);alert('ã‚³ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼')}
    }

    async function loadStatus(){
      try{
        // ã‚µãƒ¼ãƒãƒ¼ã¯æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§è¿”ã—ã¾ã™: {status: '...', created_at: '...'}
        const data = await api('/api/status')
        const el = document.getElementById('currentStatus')
        if(!data || !data.status){
          el.innerHTML = 'ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <strong>æœªè¨­å®š</strong>'
        } else {
          el.innerHTML = `ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <strong>${data.status}</strong>`
        }
      }catch(e){
        console.error(e)
        document.getElementById('currentStatus').innerHTML = 'ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <strong>æœªè¨­å®š</strong>'
      }
    }

    async function loadComments(){
      try{
        const data=await api('/api/comments/with_students')
        console.log('[loadComments] data=', data)
        const el = document.getElementById('commentsList');el.innerHTML=''
        if(data.length === 0){
          el.innerHTML='<div class="empty-state">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>'
        }else{
          data.slice(0,50).forEach(c=>{
            try{
              const d=document.createElement('div');d.className='comment-item'
              const fixedName = tryFixMojibake(c.student_name) || tryFixMojibake(c.user_id) || 'anonymous'
              const studentInfo = `<strong>${fixedName}</strong>`
              let time = ''
              try{ time = c.created_at ? new Date(c.created_at).toLocaleString('ja-JP') : '' }catch(e){ console.warn('date parse failed', e, c.created_at); time = c.created_at || '' }
              const fixedText = tryFixMojibake(c.text) || c.text || ''
              d.innerHTML=`<div class="comment-meta">${time} | ${studentInfo}</div><div>${fixedText}</div>`
              el.appendChild(d)
              // add marker on courseMap if visible
              try{ if(courseMap) addTeacherCommentMarker(c) }catch(e){}
            }catch(e){ console.error('render comment failed', e, c) }
          })
        }
      }catch(e){console.error(e);alert('ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼')}
    }

    async function loadToday(){
      try{
        const t = await api('/api/class_course')
        document.getElementById('todayInfo').innerHTML = t.course_id ? `âœ… ä»Šæ—¥ã®ã‚³ãƒ¼ã‚¹: <strong>${t.course_id}</strong>` : 'âŒ ä»Šæ—¥ã®ã‚³ãƒ¼ã‚¹ã¯æœªè¨­å®šã§ã™'
      }catch(e){console.error(e)}
    }

    document.getElementById('refresh').addEventListener('click', ()=>{loadCourses();loadStatus();loadComments();loadToday()})
    document.getElementById('refreshCourses').addEventListener('click', loadCourses)
    document.getElementById('refreshStatus').addEventListener('click', loadStatus)
    document.getElementById('refreshComments').addEventListener('click', loadComments)

    document.getElementById('uploadBtn').addEventListener('click', async ()=>{
      const f = document.getElementById('gpxfile').files[0]
      if(!f) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„')
      const fd = new FormData();fd.append('file', f)
      try{
        const btn = document.getElementById('uploadBtn')
        btn.disabled = true; btn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...'
        await fetch('/api/courses', {method:'POST', body:fd})
        alert('âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†')
        loadCourses()
      }catch(e){alert('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');console.error(e)}
      finally{
        const btn = document.getElementById('uploadBtn')
        btn.disabled = false; btn.textContent = 'ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      }
    })

    document.getElementById('setToday').addEventListener('click', async ()=>{
      const course_id = document.getElementById('todayCourse').value
      if(!course_id) return alert('ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„')
      try{
        await fetch('/api/class_course/set', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({course_id})})
        alert('âœ… è¨­å®šå®Œäº†')
        loadToday()
      }catch(e){alert('âŒ è¨­å®šå¤±æ•—');console.error(e)}
    })

    document.getElementById('setStatus').addEventListener('click', async ()=>{
      const s=document.getElementById('statusSelect').value
      if(!s) return alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„')
      try{
        await api('/api/status', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s})})
        alert('âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®šå®Œäº†')
        await loadStatus()
      }catch(e){alert('âŒ è¨­å®šå¤±æ•—: '+e.message);console.error(e)}
    })

    // initial load (do NOT overwrite server-side status)
    loadCourses();loadStatus();loadComments();loadToday()
  </script>
</body>
</html>